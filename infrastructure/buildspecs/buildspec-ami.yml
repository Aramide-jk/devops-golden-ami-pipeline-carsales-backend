version: 0.2

env:
  variables:
    PACKER_VERSION: "1.10.0"

phases:
  install:
    commands:
      - echo "Verifying OS"
      - cat /etc/os-release
      - echo "Installing dependencies"
      - dnf clean all
      - dnf makecache
      - dnf install -y wget unzip jq awscli

  pre_build:
    commands:
      - echo "Installing Packer"
      - wget -q https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip
      - unzip -o packer_${PACKER_VERSION}_linux_amd64.zip
      - chmod +x packer
      - ./packer version
      - echo "Resolving latest Docker image tag"
      - export IMAGE_TAG=$(aws ecr describe-images --repository-name backend --region us-east-1 --query 'sort_by(imageDetails,&imagePushedAt)[-1].imageTags[0]' --output text || echo latest)
      - echo "IMAGE_TAG=${IMAGE_TAG}"
      - export ECR_REPO=backend-docker-build
      - cd infrastructure/packer

  build:
    commands:
      - echo "Initializing Packer"
      - ../../packer init backend-ami.pkr.hcl
      - echo "Validating Packer template"
      - ../../packer validate -var aws_region=us-east-1 -var aws_account_id=${AWS_ACCOUNT_ID} -var project_name=${PROJECT_NAME} -var ecr_repo=${ECR_REPO} -var docker_image_tag=${IMAGE_TAG} -var instance_profile_name=${INSTANCE_PROFILE_NAME} -var vpc_id=${VPC_ID} -var subnet_id=${SUBNET_ID} backend-ami.pkr.hcl
      - echo "Building Golden AMI"
      - ../../packer build -var aws_region=us-east-1 -var aws_account_id=${AWS_ACCOUNT_ID} -var project_name=${PROJECT_NAME} -var ecr_repo=${ECR_REPO} -var docker_image_tag=${IMAGE_TAG} -var instance_profile_name=${INSTANCE_PROFILE_NAME} -var vpc_id=${VPC_ID} -var subnet_id=${SUBNET_ID} backend-ami.pkr.hcl

  post_build:
    commands:
      - echo "Extracting AMI ID"
      - cd ../..
      - export AMI_ID=$(jq -r '.builds[0].artifact_id' infrastructure/packer/packer-manifest.json | cut -d: -f2)
      - echo "AMI_ID=${AMI_ID}"
      - printf '{"amiId":"%s","imageTag":"%s"}' "$AMI_ID" "$IMAGE_TAG" > ami-info.json
      - cat ami-info.json

artifacts:
  files:
    - ami-info.json
